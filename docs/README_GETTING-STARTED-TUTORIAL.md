# Integrity Shield Getting Started Tutorial

This tutorial will guide you through:

- Storing verification key as a Kubernetes Secret

[Detect mode]
- Creating a sample ManifestIntegrityConstraint
- Creating a sample resource without signature
- Checking the resource integrity status from the ManifestIntegrityState generated by observer

[Enforce mode]
- Creating a sample ManifestIntegrityConstraint
- Creating a sample resource without signature
- Generating the signature for the sample resource
- Creating the signed sample resource
- Checking the resource integrity status from the ManifestIntegrityState generated by observer

### Storing verification key as a Kubernetes Secret
Create a verification key as a Kubernetes Secret with the following command. 
Please check [here](README_VERIFICATION_KEY_SETUP.md) to generate your own keypair.

```
gpg --export signer@enterprise.com > /tmp/pubring.gpg
kubectl create secret generic my-pubkey --from-file=key=/tmp/pubring.gpg -n integrity-shield-operator-system
```

## Detect mode (Continuous Monitoring)
### Creating a sample ManifestIntegrityConstraint
Set the appropriate signer to "signers" field and create the following ManifestIntegrityConstraint resource.
This constraint enables us to monitor configmap resources in sample-ns. 
See [Define Protected Resources](README_CONSTRAINT.md) for detailed specs.

```
$ cat <<EOF | kubectl apply -f -
  apiVersion: constraints.gatekeeper.sh/v1beta1
  kind: ManifestIntegrityConstraint
  metadata:
    name: configmap-constraint
  spec:
    match:
      kinds:
        - apiGroups: [""]
          kinds: ["ConfigMap"] 
      namespaces:
      - "sample-ns"
    parameters:
      action:
        mode: detect
      objectSelector:
      - name: sample-cm
      constraintName: configmap-constraint
      signers:
      - sample_signer@enterprise.com
      keyConfigs:
      - keySecretName: my-pubkey
        keySecretNamespace: integrity-shield-operator-system
EOF
```
### Creating a sample resource without signature
Create a sample configmap by the command below, and the configmap will be created because of detection mode.
```
$ cat <<EOF | kubectl create -n sample-ns -f -
  apiVersion: v1
  kind: ConfigMap
  metadata:
    name: sample-cm
  data:
    key1: val1
    key2: val2
    comment: comment1
EOF

configmap/sample-cm created
```
### Checking the resource integrity status from the ManifestIntegrityState generated by observer
Check the audit result for all constraints on the cluster with this command.
you can see that some resources defined in configmap-constraint are in invalid state because integrityshield.io/verifyResourceViolation label is true.
```
$ kubectl get mis --show-labels -n integrity-shield-operator-system                                                                                             
NAME                   AGE    LABELS
configmap-constraint   122m   integrityshield.io/verifyResourceIgnored=false,integrityshield.io/verifyResourceViolation=true
```
By checking verification results on per constraint, you can see which resources are violated from ManifestIntegrityState.
```
$ kubectl get mis configmap-constraint -n integrity-shield-operator-system -o yaml                                                                             
apiVersion: apis.integrityshield.io/v1
kind: ManifestIntegrityState
metadata:
  labels:
    integrityshield.io/verifyResourceIgnored: "false"
    integrityshield.io/verifyResourceViolation: "true"
  name: configmap-constraint
  namespace: integrity-shield-operator-system
spec:
  constraintName: configmap-constraint
  nonViolations: null
  observationTime: "2021-10-13 08:55:11"
  totalViolations: 1
  violation: true
  violations:
  - apiGroup: ""
    apiVersion: v1
    kind: ConfigMap
    name: sample-cm
    namespace: sample-ns
    result: 'failed to verify signature: failed to get signature: `cosign.sigstore.dev/message`
      is not found in the annotations'
status: {}
```

## Enforce mode (Admission Control)
### Creating a sample ManifestIntegrityConstraint
Now, let's switch to  **`Enforce mode`**.
To enable enforce mode, change `enforce: false` to `enforce: true`, then create the ManifestIntegrityConstraint.
```
$ cat <<EOF | kubectl apply -f -
  apiVersion: constraints.gatekeeper.sh/v1beta1
  kind: ManifestIntegrityConstraint
  metadata:
    name: configmap-constraint
  spec:
    match:
      kinds:
        - apiGroups: [""]
          kinds: ["ConfigMap"] 
      namespaces:
      - "sample-ns"
    parameters:
      action:
        mode: enforce
      objectSelector:
      - name: sample-cm
      constraintName: configmap-constraint
      signers:
      - sample_signer@enterprise.com
      keyConfigs:
      - keySecretName: my-pubkey
        keySecretNamespace: integrity-shield-operator-system
EOF

```
### Creating a sample resource without signature
Create a sample configmap by the command below, and the configmap will be blocked because the signature verification fails.

```
$ cat <<EOF | kubectl create -n sample-ns -f -
  apiVersion: v1
  kind: ConfigMap
  metadata:
    name: sample-cm
  data:
    key1: val1
    key2: val2
    comment: comment1
EOF

Error from server ([configmap-constraint] denied; {"allow": false, "message": "failed to verify signature: failed to get signature: `cosign.sigstore.dev/message` is not found in the annotations"}): error when creating "STDIN": admission webhook "validation.gatekeeper.sh" denied the request: [configmap-constraint] denied; {"allow": false, "message": "failed to verify signature: failed to get signature: `cosign.sigstore.dev/message` is not found in the annotations"}
```

You can see denied requests at the Kubernetes Event like below.
```
$ kubectl get event -n secure-ns --field-selector type=IntegrityShield                                                     
LAST SEEN   TYPE              REASON   OBJECT                   MESSAGE
65s         IntegrityShield   Deny     configmap/sample-cm   [configmap-constraint]failed to verify signature: failed to get signature: `cosign.sigstore.dev/message` is not found in the annotations
```

### Generating the signature for the sample resource
Prepare a Yaml manifest for the sample resource.
```
cat << EOF > /tmp/sample-cm.yaml
  apiVersion: v1
  kind: ConfigMap
  metadata:
    name: sample-cm
  data:
    key1: val1
    key2: val2
    comment: comment1
EOF
```
Generate a signature with the following command. Please see this [document](README_SIGNING.md).
```
$ ./scripts/gpg-annotation-sign.sh sample_signer@enterprise.com /tmp/sample-cm.yaml
```
Check the signature is attached to the sample resource.
```
$ less /tmp/sample-cm.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: sample-cm
  annotations:
    integrityshield.io/message: H4sIAMmiZmEAAzXLMQqAMAyF4T...
    integrityshield.io/signature: LS0tLS1CRUdJTiBQR1AgU...
data:
  key1: val1
  key2: val2
  comment: comment1
```
### Creating the signed sample resource
Create a sample configmap by the command below, and the signature verification will be successful and the configmap will be created.
```
$ kubectl create -f /tmp/sample-cm.yaml -n sample-ns                                                                                                            
configmap/sample-cm created
```

### Checking the resource integrity status from the ManifestIntegrityState generated by observer
Check the audit result again.
You can see that there is no violation because integrityshield.io/verifyResourceViolation label is false.
```
$ kubectl get mis --show-labels -n integrity-shield-operator-system                                                                                              
NAME                   AGE    LABELS
configmap-constraint   155m   integrityshield.io/verifyResourceIgnored=false,integrityshield.io/verifyResourceViolation=false
```
By checking verification result on per constraint, you can see the sample resource has no violation.
```
$ kubectl get mis configmap-constraint -n integrity-shield-operator-system -o yaml                                                                                
apiVersion: apis.integrityshield.io/v1
kind: ManifestIntegrityState
metadata:
  labels:
    integrityshield.io/verifyResourceIgnored: "false"
    integrityshield.io/verifyResourceViolation: "false"
  name: configmap-constraint
  namespace: integrity-shield-operator-system
spec:
  constraintName: configmap-constraint
  nonViolations:
  - apiGroup: ""
    apiVersion: ""
    kind: ConfigMap
    name: sample-cm
    namespace: sample-ns
    result: 'singed by a valid signer: sample_signer@enterprise.com'
    sigRef: __embedded_in_annotation__
    signer: sample_signer@enterprise.com
  observationTime: "2021-10-13 09:30:09"
  totalViolations: 0
  violation: false
  violations: null
status: {}
```